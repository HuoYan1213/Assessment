<!DOCTYPE html>
<html>
<head>
    <title>Access To System</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="Assets/CSS/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <section class="login-card">
        <div>
            <h1>Welcome Back</h1>
            <span>This system is primarily for team managers.</span>
        </div>
        <button id="google-signin" type="button" class="btn btn-primary">
            <i class="fa-brands fa-google"></i>
            Sign In With Google
        </button>
    </section>

    <!-- Load the Google Identity Services library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Google OAuth 2.0 Client ID and Scopes
        const CLIENT_ID = '98753007798-p9fbtjh5s3d2e4tucitkf1ob3ua2jvs7.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

        let tokenClientIndex = null;
        let gisReady = false;

        // Polling function to wait for GIS to be ready
        function waitForGISReady(timeout = 5000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                (function poll() {
                    if (window.google && google.accounts && google.accounts.oauth2) {
                        gisReady = true;
                        return resolve();
                    }
                    if (Date.now() - start > timeout) return reject(new Error('Google Identity Services not ready'));
                    setTimeout(poll, 100);
                })();
            });
        }

        // Initialize the token client for the index page
        function initIndexTokenClient() {
            if (!gisReady || tokenClientIndex) return;
            tokenClientIndex = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp && resp.access_token) {
                        // store token in sessionStorage
                        sessionStorage.setItem('g_access_token', resp.access_token);

                        // Redirect to Home page after successful sign-in
                        window.location.href = '/View/home.html';
                    } else {
                        console.error('No access token received', resp);
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Wait for GIS to be ready, then init token client
            waitForGISReady().then(() => {
                initIndexTokenClient();
            }).catch(err => {
                console.error('GIS failed to load in time:', err);
            });

            const btn = document.getElementById('google-signin');
            if (!btn) return;

            // Handle sign-in button click
            btn.addEventListener('click', () => {
                if (!gisReady) {
                    waitForGISReady().then(() => {
                        initIndexTokenClient();
                        tokenClientIndex.requestAccessToken();
                    }).catch(err => {
                        console.error('GIS not available, cannot request token:', err);
                        alert('Google Identity Services is not ready, please try again later.');
                    });
                    return;
                }
                if (!tokenClientIndex) initIndexTokenClient();
                try {
                    tokenClientIndex.requestAccessToken();
                } catch (e) {
                    console.error('requestAccessToken error', e);
                    alert('Unable to start Google authorization process, please check console errors.');
                }
            });
        });
    </script>
</body>

</html>

